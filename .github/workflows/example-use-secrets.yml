# 使用说明见 .github/DEPLOY.md
# 触发方式：① 手动 Run workflow  ② 推送到 main 时自动运行（可关）

name: Deploy with secrets

on:
  workflow_dispatch:           # 手动：Actions 页 → 选本 workflow → Run workflow
  push:
    branches: [main]            # 自动：推 main 时运行（不需要可删这段）

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create .env from secrets
        run: |
          cat << 'ENVFILE' > .env
          IMAGE_TAG=latest
          FRONTEND_PORT=8020
          BACKEND_PORT=8021
          ENV=${{ secrets.ENV }}
          DB_DSN=${{ secrets.DB_DSN }}
          REDIS_DSN=${{ secrets.REDIS_DSN }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ENVFILE

      # 部署方式二选一（或改成你自己的）：
      # A) 服务器上有 self-hosted runner：把 runs-on 改为你的 runner，下面直接执行 docker compose
      # B) 用 GitHub 官方 runner：下面通过 SSH 登录服务器再执行 docker compose
      - name: Deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}       # 如 1.2.3.4 或 my.server.com
          SSH_USER: ${{ secrets.SSH_USER }}      # 如 root 或 ubuntu
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          if [ -z "$SSH_HOST" ] || [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "未配置 SSH 相关 Secret，跳过部署。请配置 SSH_HOST、SSH_USER、SSH_PRIVATE_KEY 后重试。"
            exit 0
          fi
          echo "此处应：1) 把 .env 和 compose 文件传到服务器  2) SSH 到服务器执行 docker compose"
          echo "示例命令（需在服务器上执行）：docker compose -f docker-compose.prod.yml --env-file .env up -d --build"
          # 实际部署示例（取消注释并装好 ssh-key 后可用）：
          # mkdir -p ~/.ssh && echo "$SSH_PRIVATE_KEY" > ~/.ssh/key && chmod 600 ~/.ssh/key
          # scp -o StrictHostKeyChecking=no -i ~/.ssh/key .env docker-compose.prod.yml $SSH_USER@$SSH_HOST:~/app/
          # ssh -o StrictHostKeyChecking=no -i ~/.ssh/key $SSH_USER@$SSH_HOST "cd ~/app && docker compose -f docker-compose.prod.yml --env-file .env up -d --build"
